# API Спецификация: E-Commerce Backend

## Оглавление
- [1. Categories API](#1-categories-api)
- [2. Products API](#2-products-api)
- [3. Customers API](#3-customers-api)
- [4. Orders API](#4-orders-api)
- [5. Payments API](#5-payments-api)
- [6. Модели данных (DTO)](#6-модели-данных-dto)
- [7. Коды ответов и обработка ошибок](#7-коды-ответов-и-обработка-ошибок)

---

## 1. Categories API

Base path: `/api/categories`

### 1.1 Получить все категории

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/categories` |
| **Описание** | Получить список всех категорий товаров |
| **Авторизация** | Не требуется |

**Входные параметры:** Нет

**Выходные данные:**

| Поле | Тип | Описание |
|------|-----|----------|
| Response Body | `Array<CategoryResponse>` | Массив категорий |

**Пример ответа (200):**
```json
[
  {
    "id": 1,
    "name": "Electronics"
  },
  {
    "id": 2,
    "name": "Books"
  }
]
```

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно. Возвращает массив категорий (может быть пустым) |
| 500 | Внутренняя ошибка сервера |

---

### 1.2 Получить категорию по ID

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/categories/{id}` |
| **Описание** | Получить информацию о категории по идентификатору |
| **Авторизация** | Не требуется |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID категории |

**Выходные данные:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Идентификатор категории |
| name | String | Название категории |

**Пример ответа (200):**
```json
{
  "id": 1,
  "name": "Electronics"
}
```

**Бизнес-правила:**
- Категория должна существовать

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Категория не найдена |

---

### 1.3 Создать категорию

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `POST /api/categories` |
| **Описание** | Создать новую категорию товаров |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Поле | Тип | Обязательный | Описание | Валидация |
|------|-----|--------------|----------|-----------|
| name | String | Да | Название категории | @NotBlank, @Size(min=3, max=100) |

**Пример запроса:**
```json
{
  "name": "Electronics"
}
```

**Выходные данные:** `CategoryResponse`

**Пример ответа (201):**
```json
{
  "id": 1,
  "name": "Electronics"
}
```

**Бизнес-правила:**
- Название категории должно быть уникальным
- Название не может быть пустым
- Минимальная длина - 3 символа, максимальная - 100

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 201 | Категория успешно создана |
| 400 | Ошибка валидации (невалидное имя) |
| 409 | Конфликт (категория с таким именем уже существует) |

---

### 1.4 Обновить категорию

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `PUT /api/categories/{id}` |
| **Описание** | Обновить существующую категорию |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание | Валидация |
|----------|-----|--------------|-----|----------|-----------|
| id | Long | Да | Path | ID категории | - |
| name | String | Да | Body | Новое название | @NotBlank, @Size(min=3, max=100) |

**Пример запроса:**
```json
{
  "name": "Consumer Electronics"
}
```

**Выходные данные:** `CategoryResponse`

**Бизнес-правила:**
- Категория должна существовать
- Новое название должно быть уникальным

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Категория успешно обновлена |
| 400 | Ошибка валидации |
| 404 | Категория не найдена |
| 409 | Конфликт (имя уже используется) |

---

### 1.5 Удалить категорию

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `DELETE /api/categories/{id}` |
| **Описание** | Удалить категорию |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID категории |

**Выходные данные:** Нет (пустое тело)

**Бизнес-правила:**
- Категория должна существовать
- **Нельзя удалить категорию, если к ней привязаны товары**

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 204 | Категория успешно удалена |
| 404 | Категория не найдена |
| 409 | Конфликт (есть связанные товары) |

---

## 2. Products API

Base path: `/api/products`

### 2.1 Получить все товары

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/products` |
| **Описание** | Получить список товаров с фильтрацией и пагинацией |
| **Авторизация** | Не требуется |

**Входные параметры (Query params):**

| Параметр | Тип | Обязательный | Описание | По умолчанию |
|----------|-----|--------------|----------|--------------|
| categoryId | Long | Нет | Фильтр по категории | - |
| minPrice | BigDecimal | Нет | Минимальная цена | - |
| maxPrice | BigDecimal | Нет | Максимальная цена | - |
| inStock | Boolean | Нет | Только в наличии (in_stock > 0) | false |
| page | Integer | Нет | Номер страницы (0-based) | 0 |
| size | Integer | Нет | Размер страницы | 20 |
| sort | String | Нет | Сортировка (price,asc / name,desc) | id,asc |

**Выходные данные:**

| Поле | Тип | Описание |
|------|-----|----------|
| content | `Array<ProductListResponse>` | Массив товаров |
| totalElements | Long | Общее количество товаров |
| totalPages | Integer | Общее количество страниц |
| page | Integer | Текущая страница |
| size | Integer | Размер страницы |

**ProductListResponse** (краткая версия для списка):

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID товара |
| name | String | Название |
| price | BigDecimal | Цена |
| inStock | Integer | Количество на складе |
| categoryName | String | Название категории |

**Пример ответа (200):**
```json
{
  "content": [
    {
      "id": 1,
      "name": "Laptop HP",
      "price": 999.99,
      "inStock": 15,
      "categoryName": "Electronics"
    }
  ],
  "totalElements": 45,
  "totalPages": 3,
  "page": 0,
  "size": 20
}
```

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 400 | Невалидные параметры фильтрации |

---

### 2.2 Получить товар по ID

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/products/{id}` |
| **Описание** | Получить детальную информацию о товаре |
| **Авторизация** | Не требуется |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID товара |

**Выходные данные:** `ProductResponse`

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID товара |
| name | String | Название |
| price | BigDecimal | Цена |
| inStock | Integer | Количество на складе |
| category | CategoryResponse | Объект категории |
| createdAt | DateTime | Дата создания |

**Пример ответа (200):**
```json
{
  "id": 1,
  "name": "Laptop HP Pavilion",
  "price": 999.99,
  "inStock": 15,
  "category": {
    "id": 1,
    "name": "Electronics"
  },
  "createdAt": "2024-01-15T10:30:00Z"
}
```

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Товар не найден |

---

### 2.3 Создать товар

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `POST /api/products` |
| **Описание** | Создать новый товар |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Поле | Тип | Обязательный | Описание | Валидация |
|------|-----|--------------|----------|-----------|
| name | String | Да | Название товара | @NotBlank, @Size(min=3, max=200) |
| price | BigDecimal | Да | Цена | @NotNull, @DecimalMin("0.01"), @Digits(integer=8, fraction=2) |
| inStock | Integer | Да | Количество | @NotNull, @Min(0) |
| categoryId | Long | Да | ID категории | @NotNull, @Positive, @CategoryExists |

**Пример запроса:**
```json
{
  "name": "Laptop HP Pavilion",
  "price": 999.99,
  "inStock": 15,
  "categoryId": 1
}
```

**Выходные данные:** `ProductResponse`

**Бизнес-правила:**
- Категория должна существовать
- Цена должна быть положительной
- Количество не может быть отрицательным
- Название не должно быть пустым

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 201 | Товар успешно создан |
| 400 | Ошибка валидации (невалидные данные) |
| 404 | Категория не найдена |

---

### 2.4 Обновить товар

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `PUT /api/products/{id}` |
| **Описание** | Обновить информацию о товаре |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание | Валидация |
|----------|-----|--------------|-----|----------|-----------|
| id | Long | Да | Path | ID товара | - |
| name | String | Нет | Body | Название | @Size(min=3, max=200) |
| price | BigDecimal | Нет | Body | Цена | @DecimalMin("0.01") |
| inStock | Integer | Нет | Body | Количество | @Min(0) |
| categoryId | Long | Нет | Body | ID категории | @Positive |

**Примечание:** Обновляются только переданные поля (partial update)

**Пример запроса:**
```json
{
  "price": 899.99,
  "inStock": 20
}
```

**Выходные данные:** `ProductResponse`

**Бизнес-правила:**
- Товар должен существовать
- Если указан categoryId - категория должна существовать

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Товар успешно обновлен |
| 400 | Ошибка валидации |
| 404 | Товар или категория не найдены |

---

### 2.5 Удалить товар

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `DELETE /api/products/{id}` |
| **Описание** | Удалить товар |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID товара |

**Выходные данные:** Нет

**Бизнес-правила:**
- Товар должен существовать
- **Нельзя удалить товар, если есть связанные order_items в активных заказах**
- Можно удалить, если товар только в отмененных/доставленных заказах

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 204 | Товар успешно удален |
| 404 | Товар не найден |
| 409 | Конфликт (есть связанные заказы) |

---

### 2.6 Получить топ популярных товаров

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/products/top-selling` |
| **Описание** | Получить топ товаров по количеству продаж |
| **Авторизация** | Не требуется |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание | По умолчанию |
|----------|-----|--------------|-----|----------|--------------|
| limit | Integer | Нет | Query | Количество товаров | 10 |
| categoryId | Long | Нет | Query | Фильтр по категории | - |

**Выходные данные:** `Array<ProductSalesResponse>`

| Поле | Тип | Описание |
|------|-----|----------|
| productId | Long | ID товара |
| productName | String | Название товара |
| totalSold | Integer | Количество проданных единиц |
| totalRevenue | BigDecimal | Общая выручка от продаж |

**Бизнес-правила:**
- Учитываются только заказы со статусами: PAID, SHIPPED, DELIVERED
- Сортировка по количеству продаж (DESC)

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |

---

## 3. Customers API

Base path: `/api/customers`

### 3.1 Получить всех клиентов

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/customers` |
| **Описание** | Получить список клиентов |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Описание | По умолчанию |
|----------|-----|--------------|----------|--------------|
| search | String | Нет | Поиск по email/имени | - |
| page | Integer | Нет | Номер страницы | 0 |
| size | Integer | Нет | Размер страницы | 20 |

**Выходные данные:** Paginated `CustomerResponse`

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |

---

### 3.2 Получить клиента по ID

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/customers/{id}` |
| **Описание** | Получить информацию о клиенте |
| **Авторизация** | Требуется (admin или сам клиент) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID клиента |

**Выходные данные:** `CustomerResponse`

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID клиента |
| firstName | String | Имя |
| lastName | String | Фамилия |
| email | String | Email |
| city | String | Город |
| country | String | Страна |
| createdAt | DateTime | Дата регистрации |

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Клиент не найден |

---

### 3.3 Создать клиента (регистрация)

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `POST /api/customers` |
| **Описание** | Регистрация нового клиента |
| **Авторизация** | Не требуется |

**Входные параметры:**

| Поле | Тип | Обязательный | Описание | Валидация |
|------|-----|--------------|----------|-----------|
| firstName | String | Да | Имя | @NotBlank, @Size(min=2, max=100) |
| lastName | String | Да | Фамилия | @NotBlank, @Size(min=2, max=100) |
| email | String | Да | Email | @NotBlank, @Email, @UniqueEmail |
| city | String | Да | Город | @NotBlank, @Size(max=100) |
| country | String | Да | Страна | @NotBlank, @Size(max=100) |

**Пример запроса:**
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john.doe@example.com",
  "city": "New York",
  "country": "USA"
}
```

**Выходные данные:** `CustomerResponse`

**Бизнес-правила:**
- Email должен быть уникальным
- Email должен иметь валидный формат
- Имя и фамилия - минимум 2 символа

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 201 | Клиент успешно зарегистрирован |
| 400 | Ошибка валидации |
| 409 | Email уже используется |

---

### 3.4 Обновить клиента

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `PUT /api/customers/{id}` |
| **Описание** | Обновить информацию о клиенте |
| **Авторизация** | Требуется (admin или сам клиент) |

**Входные параметры:** Partial update (как в Products)

**Бизнес-правила:**
- Нельзя изменить email на уже существующий
- Клиент должен существовать

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно обновлено |
| 400 | Ошибка валидации |
| 404 | Клиент не найден |
| 409 | Email уже используется |

---

### 3.5 Получить заказы клиента

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/customers/{id}/orders` |
| **Описание** | Получить историю заказов клиента |
| **Авторизация** | Требуется (admin или сам клиент) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание | По умолчанию |
|----------|-----|--------------|-----|----------|--------------|
| id | Long | Да | Path | ID клиента | - |
| status | OrderStatus | Нет | Query | Фильтр по статусу | - |
| fromDate | Date | Нет | Query | Дата начала периода | - |
| toDate | Date | Нет | Query | Дата конца периода | - |

**Выходные данные:** `Array<OrderSummaryResponse>`

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID заказа |
| orderDate | DateTime | Дата заказа |
| status | OrderStatus | Статус |
| totalAmount | BigDecimal | Общая сумма |
| itemsCount | Integer | Количество позиций |

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Клиент не найден |

---

## 4. Orders API

Base path: `/api/orders`

### 4.1 Получить все заказы

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/orders` |
| **Описание** | Получить список заказов с фильтрацией |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Описание | По умолчанию |
|----------|-----|--------------|----------|--------------|
| customerId | Long | Нет | Фильтр по клиенту | - |
| status | OrderStatus | Нет | Фильтр по статусу | - |
| fromDate | Date | Нет | Дата начала периода | - |
| toDate | Date | Нет | Дата конца периода | - |
| page | Integer | Нет | Номер страницы | 0 |
| size | Integer | Нет | Размер страницы | 20 |

**Выходные данные:** Paginated `OrderSummaryResponse`

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |

---

### 4.2 Получить заказ по ID

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/orders/{id}` |
| **Описание** | Получить детальную информацию о заказе |
| **Авторизация** | Требуется (admin или владелец заказа) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID заказа |

**Выходные данные:** `OrderResponse`

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID заказа |
| customer | CustomerResponse | Информация о клиенте |
| orderDate | DateTime | Дата заказа |
| status | OrderStatus | Статус заказа |
| items | `Array<OrderItemResponse>` | Позиции заказа |
| totalAmount | BigDecimal | Общая сумма |
| shippingCity | String | Город доставки |
| shippingCountry | String | Страна доставки |
| payment | PaymentResponse | Информация об оплате (если есть) |

**OrderItemResponse:**

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID позиции |
| product | ProductResponse | Информация о товаре |
| quantity | Integer | Количество |
| unitPrice | BigDecimal | Цена за единицу |
| subtotal | BigDecimal | Сумма (quantity * unitPrice) |

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Заказ не найден |

---

### 4.3 Создать заказ

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `POST /api/orders` |
| **Описание** | Создать новый заказ |
| **Авторизация** | Требуется |

**Входные параметры:**

| Поле | Тип | Обязательный | Описание | Валидация |
|------|-----|--------------|----------|-----------|
| customerId | Long | Да | ID клиента | @NotNull, @Positive |
| items | Array | Да | Позиции заказа | @NotEmpty, @Valid |
| items[].productId | Long | Да | ID товара | @NotNull, @Positive |
| items[].quantity | Integer | Да | Количество | @Min(1), @Max(1000) |
| shippingCity | String | Да | Город доставки | @NotBlank |
| shippingCountry | String | Да | Страна доставки | @NotBlank |

**Пример запроса:**
```json
{
  "customerId": 1,
  "items": [
    {
      "productId": 1,
      "quantity": 2
    },
    {
      "productId": 5,
      "quantity": 1
    }
  ],
  "shippingCity": "New York",
  "shippingCountry": "USA"
}
```

**Выходные данные:** `OrderResponse`

**Бизнес-правила:**
1. Клиент должен существовать
2. Все товары должны существовать
3. **Для каждого товара проверить наличие на складе:**
   - Если `product.inStock < quantity` → ошибка 400 (InsufficientStockException)
4. **Уменьшить остатки на складе для всех товаров**
5. Установить статус заказа в `PENDING`
6. Зафиксировать цену товара на момент заказа (в order_items.unit_price)
7. **ВСЁ В ОДНОЙ ТРАНЗАКЦИИ!**

**Флоу операции:**
```
1. Валидация входных данных
2. Проверка существования клиента
3. Для каждой позиции:
   a. Проверить существование товара
   b. Проверить достаточность остатка
4. Создать Order (status=PENDING)
5. Для каждой позиции:
   a. Уменьшить product.inStock
   b. Создать OrderItem с текущей ценой
6. Сохранить всё
7. Вернуть OrderResponse
```

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 201 | Заказ успешно создан |
| 400 | Ошибка валидации или недостаточно товара на складе |
| 404 | Клиент или товар не найден |

---

### 4.4 Изменить статус заказа

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `PUT /api/orders/{id}/status` |
| **Описание** | Изменить статус заказа |
| **Авторизация** | Требуется (admin) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание | Валидация |
|----------|-----|--------------|-----|----------|-----------|
| id | Long | Да | Path | ID заказа | - |
| status | OrderStatus | Да | Body | Новый статус | @NotNull |

**Пример запроса:**
```json
{
  "status": "SHIPPED"
}
```

**Выходные данные:** `OrderResponse`

**Бизнес-правила - допустимые переходы статусов:**

| Текущий статус | Разрешенные переходы |
|----------------|----------------------|
| PENDING | PAID, CANCELLED |
| PAID | SHIPPED, CANCELLED |
| SHIPPED | DELIVERED |
| DELIVERED | (нет переходов) |
| CANCELLED | (нет переходов) |

**Дополнительные правила:**
- Нельзя изменить статус на текущий
- При переходе из любого статуса в CANCELLED → вернуть товары на склад (увеличить in_stock)

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Статус успешно изменен |
| 400 | Недопустимый переход статуса |
| 404 | Заказ не найден |

---

### 4.5 Отменить заказ

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `DELETE /api/orders/{id}` |
| **Описание** | Отменить заказ (изменить статус на CANCELLED) |
| **Авторизация** | Требуется (admin или владелец заказа) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| id | Long | Да | Path | ID заказа |

**Выходные данные:** Нет

**Бизнес-правила:**
- Можно отменить только заказы в статусах PENDING или PAID
- Нельзя отменить SHIPPED или DELIVERED
- При отмене вернуть товары на склад

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 204 | Заказ успешно отменен |
| 400 | Невозможно отменить заказ (неправильный статус) |
| 404 | Заказ не найден |

---

## 5. Payments API

Base path: `/api/payments`

### 5.1 Создать платеж

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `POST /api/payments` |
| **Описание** | Создать платеж для заказа (оплатить заказ) |
| **Авторизация** | Требуется (владелец заказа) |

**Входные параметры:**

| Поле | Тип | Обязательный | Описание | Валидация |
|------|-----|--------------|----------|-----------|
| orderId | Long | Да | ID заказа | @NotNull, @Positive |
| method | PaymentMethod | Да | Метод оплаты | @NotNull |
| amount | BigDecimal | Да | Сумма платежа | @NotNull, @DecimalMin("0.01") |

**PaymentMethod enum:** `CARD`, `PAYPAL`, `BANK_TRANSFER`, `CASH`

**Пример запроса:**
```json
{
  "orderId": 123,
  "method": "CARD",
  "amount": 1599.98
}
```

**Выходные данные:** `PaymentResponse`

| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | ID платежа |
| orderId | Long | ID заказа |
| method | PaymentMethod | Метод оплаты |
| amount | BigDecimal | Сумма |
| paidAt | DateTime | Дата и время оплаты |

**Бизнес-правила:**
1. Заказ должен существовать
2. Заказ должен быть в статусе `PENDING`
3. У заказа еще не должно быть платежа (проверить уникальность)
4. Сумма платежа должна совпадать с общей суммой заказа
5. После создания платежа изменить статус заказа на `PAID`
6. **ВСЁ В ОДНОЙ ТРАНЗАКЦИИ!**

**Флоу операции:**
```
1. Валидация входных данных
2. Проверка существования заказа
3. Проверка статуса заказа (должен быть PENDING)
4. Проверка отсутствия платежа для заказа
5. Расчет общей суммы заказа
6. Проверка соответствия amount с totalAmount заказа
7. Создать Payment
8. Изменить Order.status на PAID
9. Сохранить
10. Вернуть PaymentResponse
```

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 201 | Платеж успешно создан, заказ оплачен |
| 400 | Ошибка валидации, неверная сумма, неверный статус заказа |
| 404 | Заказ не найден |
| 409 | Платеж уже существует для этого заказа |

---

### 5.2 Получить платеж по заказу

| Параметр | Значение |
|----------|----------|
| **Endpoint** | `GET /api/payments/order/{orderId}` |
| **Описание** | Получить информацию о платеже для заказа |
| **Авторизация** | Требуется (admin или владелец заказа) |

**Входные параметры:**

| Параметр | Тип | Обязательный | Где | Описание |
|----------|-----|--------------|-----|----------|
| orderId | Long | Да | Path | ID заказа |

**Выходные данные:** `PaymentResponse`

**Коды ответов:**

| Код | Описание |
|-----|----------|
| 200 | Успешно |
| 404 | Платеж не найден (или заказ не найден) |

---

## 6. Модели данных (DTO)

### 6.1 CategoryResponse

```typescript
{
  id: Long
  name: String
}
```

### 6.2 CategoryRequest

```typescript
{
  name: String  // @NotBlank, @Size(3-100)
}
```

### 6.3 ProductResponse

```typescript
{
  id: Long
  name: String
  price: BigDecimal
  inStock: Integer
  category: CategoryResponse
  createdAt: DateTime
}
```

### 6.4 ProductCreateRequest

```typescript
{
  name: String           // @NotBlank, @Size(3-200)
  price: BigDecimal      // @NotNull, @DecimalMin("0.01")
  inStock: Integer       // @NotNull, @Min(0)
  categoryId: Long       // @NotNull, @Positive
}
```

### 6.5 CustomerResponse

```typescript
{
  id: Long
  firstName: String
  lastName: String
  email: String
  city: String
  country: String
  createdAt: DateTime
}
```

### 6.6 CustomerCreateRequest

```typescript
{
  firstName: String     // @NotBlank, @Size(2-100)
  lastName: String      // @NotBlank, @Size(2-100)
  email: String         // @NotBlank, @Email
  city: String          // @NotBlank
  country: String       // @NotBlank
}
```

### 6.7 OrderResponse

```typescript
{
  id: Long
  customer: CustomerResponse
  orderDate: DateTime
  status: OrderStatus
  items: OrderItemResponse[]
  totalAmount: BigDecimal
  shippingCity: String
  shippingCountry: String
  payment: PaymentResponse | null
}
```

### 6.8 OrderCreateRequest

```typescript
{
  customerId: Long                // @NotNull
  items: OrderItemRequest[]       // @NotEmpty, @Valid
  shippingCity: String            // @NotBlank
  shippingCountry: String         // @NotBlank
}
```

### 6.9 OrderItemRequest

```typescript
{
  productId: Long        // @NotNull, @Positive
  quantity: Integer      // @Min(1), @Max(1000)
}
```

### 6.10 OrderItemResponse

```typescript
{
  id: Long
  product: ProductResponse
  quantity: Integer
  unitPrice: BigDecimal
  subtotal: BigDecimal   // calculated: quantity * unitPrice
}
```

### 6.11 PaymentResponse

```typescript
{
  id: Long
  orderId: Long
  method: PaymentMethod
  amount: BigDecimal
  paidAt: DateTime
}
```

### 6.12 PaymentCreateRequest

```typescript
{
  orderId: Long          // @NotNull
  method: PaymentMethod  // @NotNull
  amount: BigDecimal     // @NotNull, @DecimalMin("0.01")
}
```

---

## 7. Коды ответов и обработка ошибок

### 7.1 HTTP Status Codes

| Код | Название | Когда использовать |
|-----|----------|-------------------|
| 200 | OK | Успешный GET, PUT, PATCH |
| 201 | Created | Успешный POST (создание ресурса) |
| 204 | No Content | Успешный DELETE |
| 400 | Bad Request | Ошибка валидации, бизнес-правила нарушены |
| 404 | Not Found | Ресурс не найден |
| 409 | Conflict | Конфликт (дубликат, связанные данные) |
| 500 | Internal Server Error | Неожиданная ошибка сервера |

### 7.2 Структура ответа об ошибке

Все ошибки должны возвращаться в едином формате:

```typescript
{
  timestamp: DateTime      // Время ошибки
  status: Integer          // HTTP статус
  error: String            // Название ошибки (Bad Request, Not Found, etc.)
  message: String          // Человекочитаемое описание
  path: String             // URL запроса
  details?: Object         // Опционально: детали валидации
}
```

**Пример ответа 404:**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "status": 404,
  "error": "Not Found",
  "message": "Product with id 999 not found",
  "path": "/api/products/999"
}
```

**Пример ответа 400 (валидация):**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "status": 400,
  "error": "Validation Failed",
  "message": "Input validation failed",
  "path": "/api/products",
  "details": {
    "name": "Product name must be between 3 and 200 characters",
    "price": "Price must be positive"
  }
}
```

**Пример ответа 400 (бизнес-правило):**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "status": 400,
  "error": "Insufficient Stock",
  "message": "Product 'Laptop HP' has only 5 units in stock, requested 10",
  "path": "/api/orders"
}
```

**Пример ответа 409:**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "status": 409,
  "error": "Conflict",
  "message": "Cannot delete category: 15 products are linked to this category",
  "path": "/api/categories/1"
}
```

### 7.3 Кастомные исключения

Создать следующие exception классы:

| Exception | HTTP Status | Когда выбрасывать |
|-----------|-------------|-------------------|
| ResourceNotFoundException | 404 | Сущность не найдена по ID |
| InsufficientStockException | 400 | Недостаточно товара на складе |
| InvalidOrderStatusTransitionException | 400 | Недопустимый переход статуса заказа |
| DuplicateResourceException | 409 | Попытка создать дубликат (email, имя категории) |
| OrderAlreadyPaidException | 409 | Попытка оплатить уже оплаченный заказ |
| CannotCancelOrderException | 400 | Попытка отменить доставленный заказ |
| PaymentAmountMismatchException | 400 | Сумма платежа не совпадает с суммой заказа |

---

## 8. Дополнительные требования

### 8.1 Транзакционность

Операции, требующие @Transactional:

1. **Создание заказа** (POST /api/orders)
   - Создание Order + OrderItems
   - Уменьшение in_stock
   - Rollback при ошибке

2. **Создание платежа** (POST /api/payments)
   - Создание Payment
   - Изменение Order.status
   - Rollback при ошибке

3. **Отмена заказа** (DELETE /api/orders/{id})
   - Изменение Order.status
   - Возврат товара на склад
   - Rollback при ошибке

4. **Изменение статуса на CANCELLED** (PUT /api/orders/{id}/status)
   - Изменение статуса
   - Возврат товара на склад
   - Rollback при ошибке

### 8.2 Логирование

Логировать следующие события:

- INFO: Создание заказа (orderId, customerId, totalAmount)
- INFO: Оплата заказа (paymentId, orderId, amount)
- INFO: Изменение статуса заказа (orderId, oldStatus, newStatus)
- WARN: Попытка недопустимого перехода статуса
- WARN: Попытка оплатить уже оплаченный заказ
- ERROR: Все исключения (с stack trace)

### 8.3 Вычисляемые поля

Поля, которые рассчитываются, а не хранятся в БД:

- `OrderItemResponse.subtotal` = quantity * unitPrice
- `OrderResponse.totalAmount` = SUM(items[].subtotal)

---

## Приложение: Примеры запросов для тестирования

### Создание категории
```bash
POST /api/categories
{
  "name": "Electronics"
}
```

### Создание товара
```bash
POST /api/products
{
  "name": "Laptop HP Pavilion",
  "price": 999.99,
  "inStock": 15,
  "categoryId": 1
}
```

### Регистрация клиента
```bash
POST /api/customers
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "city": "New York",
  "country": "USA"
}
```

### Создание заказа
```bash
POST /api/orders
{
  "customerId": 1,
  "items": [
    {"productId": 1, "quantity": 2},
    {"productId": 2, "quantity": 1}
  ],
  "shippingCity": "New York",
  "shippingCountry": "USA"
}
```

### Оплата заказа
```bash
POST /api/payments
{
  "orderId": 1,
  "method": "CARD",
  "amount": 2999.97
}
```

---

**Конец спецификации**

